
{%csrf_token%}
<form class="sortable" hx-trigger="end" hx-post="/sort" hx-target="#blocks">
        {%for block in blocks%}
        <div class="htmx-indicator">Updating...</div>    
        <div>
            <li>
                
                {%if block.active%}

                <input type="checkbox" name="active" id="active" class="active" onChange="blockActivity('{{block.uid}}')" checked>
                {%else%}
                <input type="checkbox" name="active" id="active" class="active" onChange="blockActivity('{{block.uid}}')">
                {%endif%}
                
                <input type="hidden" name="block_order" value="{{block.pk}}">
                
                {% if block.link%}
                <input class="title" name="title" value="{{block.link.title}}" id="{{block.uid}}" placeholder="Заголовок" onfocusout="updateTitle(this.id,this.value)">
                <input name="url" class='url' value="{{block.link.url}}" id="{{block.uid}}" placeholder="Ссылка" onfocusout="updateURL(this.id,this.value)">
                <div id="urlError" style="display:none;">
                    <p>Пожалуйста, введите корректную ссылку.</p>
                </div>
                    <button hx-delete="{%url 'link:delete-block' block.uid%}" hx-target="#blocks">Delete</button>
                {% endif%}
            </li>
            
        </div>
        {%empty%}
        {%endfor%}
    <script>

        document.body.addEventListener('htmx:configRequest',(event)=>{
            event.detail.headers['X-CSRFToken']="{{csrf_token}}";
        })
        
        function blockActivity(uid){
            $.ajax({
            url:"{%url 'link:block-activity'%}",
            data:{
                "csrfmiddlewaretoken":"{{csrf_token}}",
                'uid':uid,
            },
            method:"POST",
            });
        };
        function updateTitle(uid,title){
            $.ajax({
            url:"{%url 'link:update-title'%}",
            data:{
                "csrfmiddlewaretoken":"{{csrf_token}}",
                'uid':uid,
                'title':title,
            },
            method:"POST",
            });
        };
        function updateURL(uid,url){
            if(/^(?:(?:(?:https?|ftp):)?\/\/)(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})).?)(?::\d{2,5})?(?:[/?#]\S*)?$/i.test( url )===true){
                document.getElementById('urlError').style.display='none';
                $.ajax({
                url:"{%url 'link:update-url'%}",
                    data:{
                        "csrfmiddlewaretoken":"{{csrf_token}}",
                        'uid':uid,
                        'url':url,
                    },
                    method:"POST",
                });
            }
            else if(url==''){
                document.getElementById('urlError').style.display='none';
            }
            else{
                document.getElementById('urlError').style.display='';
            }    
        };
    </script>
